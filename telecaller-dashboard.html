<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Telecaller Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #2563eb, #1e3a8a, #3b82f6);
      background-size: 300% 300%;
      animation: bgShift 10s ease infinite;
      font-family: "Poppins", sans-serif;
    }
    @keyframes bgShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .glass {
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .glass:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    select {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    option { color: black; }
  </style>
</head>

<body class="min-h-screen flex flex-col text-white">
  <!-- Navbar -->
  <nav class="flex justify-between items-center p-5 bg-white/10">
    <h1 id="welcomeText" class="text-xl font-semibold">Welcome</h1>
    <div class="flex items-center gap-3">
      <button id="followupBtn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-md text-sm font-medium">
        Followups
      </button>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md text-sm font-medium">
        Logout
      </button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Leads</h2>
      <div class="flex gap-3 items-center">
        <input
          type="text"
          id="searchInput"
          placeholder="Search by name or number..."
          class="px-3 py-2 rounded-md text-black w-60"
        />
        <select id="filterSelect" class="px-3 py-2 rounded-md text-black">
          <option value="today" selected>Today</option>
          <option value="total">Total</option>
          <option value="notPicked">Not Picked</option>
          <option value="remaining">Not Called / Remaining</option>
          <option value="custom">Custom Date Range</option>
        </select>
      </div>
    </div>

    <div id="leadsContainer" class="flex flex-col gap-6 overflow-y-auto max-h-[80vh] p-2">
      <!-- Leads grouped by date will appear here -->
    </div>
  </main>

  <!-- Date Range Modal -->
  <div id="dateRangeModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white text-black rounded-lg p-6 w-80 relative">
      <h3 class="text-lg font-semibold mb-4">Select Date Range</h3>
      <label class="block mb-2 text-sm font-medium">From:</label>
      <input type="date" id="fromDate" class="border rounded w-full p-2 mb-3" />
      <label class="block mb-2 text-sm font-medium">To:</label>
      <input type="date" id="toDate" class="border rounded w-full p-2 mb-4" />
      <div class="flex justify-end gap-3">
        <button id="cancelDateRange" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        <button id="applyDateRange" class="bg-blue-500 text-white px-4 py-2 rounded">Apply</button>
      </div>
    </div>
  </div>

  <!-- Remarks Modal -->
  <div id="remarksModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white text-black rounded-lg w-96 max-h-[70vh] overflow-y-auto p-5 relative">
      <button id="closeRemarks" class="absolute top-2 right-3 text-xl text-gray-500 hover:text-black">&times;</button>
      <h3 id="remarksTitle" class="text-lg font-bold mb-3">Remarks</h3>
      <ul id="remarksList" class="space-y-2"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // üî• Firebase Config
    const firebaseConfig = {
  apiKey: "AIzaSyCaFjdwtxT13RdmVau9_6JEFBEIY1xojTY",
  authDomain: "shreejeeayucare-df742.firebaseapp.com",
  databaseURL: "https://shreejeeayucare-df742-default-rtdb.firebaseio.com",
  projectId: "shreejeeayucare-df742",
  storageBucket: "shreejeeayucare-df742.firebasestorage.app",
  messagingSenderId: "119318664445",
  appId: "1:119318664445:web:4399d3ddd4a9decc0f5a94",
  measurementId: "G-GKWG1RLZ5R"
};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const currentTelecaller = JSON.parse(localStorage.getItem("currentTelecaller"));
    if (!currentTelecaller || !currentTelecaller.email) window.location.href = "index.html";

    const telecallerEmailKey = currentTelecaller.email.replace(/\./g, "_");
    const welcomeText = document.getElementById("welcomeText");
    const leadsContainer = document.getElementById("leadsContainer");
    const searchInput = document.getElementById("searchInput");
    const filterSelect = document.getElementById("filterSelect");

    

    welcomeText.textContent = `Welcome, ${currentTelecaller.name || "Telecaller"}`;

    let allLeads = {};
    let dateFilter = "today";
    let customRange = null;

    const telecallerRef = ref(db, `Telecallers/${telecallerEmailKey}/Leads`);

    onValue(telecallerRef, (snapshot) => {
      allLeads = snapshot.exists() ? snapshot.val() : {};
      renderLeads();
    });

    // ‚úÖ Filtering and Searching
    filterSelect.addEventListener("change", (e) => {
      dateFilter = e.target.value;
      if (dateFilter === "custom") {
        document.getElementById("dateRangeModal").classList.remove("hidden");
      } else {
        renderLeads();
      }
    });

    document.getElementById("cancelDateRange").addEventListener("click", () => {
      document.getElementById("dateRangeModal").classList.add("hidden");
      filterSelect.value = "today";
      dateFilter = "today";
      renderLeads();
    });

    document.getElementById("applyDateRange").addEventListener("click", () => {
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      if (from && to) {
        customRange = { from: new Date(from), to: new Date(to) };
        document.getElementById("dateRangeModal").classList.add("hidden");
        renderLeads();
      }
    });

    searchInput.addEventListener("input", () => renderLeads());

    // ‚úÖ Render leads with filters
    function renderLeads() {
      leadsContainer.innerHTML = "";
      let leadsArray = Object.entries(allLeads).map(([number, data]) => ({ number, ...data }));

      // Apply search filter
      const searchVal = searchInput.value.toLowerCase();
      if (searchVal) {
        leadsArray = leadsArray.filter(l =>
          (l.Name || "").toLowerCase().includes(searchVal) ||
          l.number.includes(searchVal)
        );
      }

      // Apply date filter
const now = new Date();
if (dateFilter === "today") {
  leadsArray = leadsArray.filter(l => {
    const d = new Date(l.Time);
    return d.toDateString() === now.toDateString();
  });
} else if (dateFilter === "notPicked") {
  leadsArray = leadsArray.filter(l => l.Status === "Not Picked");
} else if (dateFilter === "remaining") {
  leadsArray = leadsArray.filter(l => l.Status === "Not Called");
} else if (dateFilter === "custom" && customRange) {
  leadsArray = leadsArray.filter(l => {
    const d = new Date(l.Time);
    // ‚úÖ Include from and to dates (make them inclusive)
    const fromDate = new Date(customRange.from.setHours(0, 0, 0, 0));
    const toDate = new Date(customRange.to.setHours(23, 59, 59, 999));
    return d >= fromDate && d <= toDate;
  });
}


      // Group by date
      const groupedByDate = {};
      leadsArray.forEach(lead => {
        if (!lead.Time) return;
        const datePart = new Date(lead.Time).toDateString();
        if (!groupedByDate[datePart]) groupedByDate[datePart] = [];
        groupedByDate[datePart].push(lead);
      });

      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

      if (sortedDates.length === 0) {
        leadsContainer.innerHTML = `<p class="text-center text-white/70 mt-10">No Leads Found</p>`;
        return;
      }

      sortedDates.forEach(dateKey => {
        const section = document.createElement("div");
        section.innerHTML = `<h3 class="text-lg font-semibold mb-3 border-b border-white/20 pb-1">${new Date(dateKey).toDateString()}</h3>`;
        groupedByDate[dateKey]
          .sort((a, b) => new Date(b.Time) - new Date(a.Time))
          .forEach(lead => {
            const card = document.createElement("div");
            card.className = "glass p-4 rounded-lg shadow-md mb-3";
            const currentStatus = lead.Status || "Not Called";
            card.innerHTML = `
              <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                  <h4 class="text-lg font-semibold">${lead.Name || "Unknown"}</h4>
                  <button class="text-yellow-400 hover:text-yellow-300 text-sm font-semibold" data-edit="${lead.number}">‚úèÔ∏è</button>
                </div>
                <select data-status="${lead.number}" class="rounded-md text-sm px-2 py-1">
                  <option ${currentStatus === "Not Interested" ? "selected" : ""}>Not Interested</option>
                  <option ${currentStatus === "Picked" ? "selected" : ""}>Picked</option>
                  <option ${currentStatus === "Not Picked" ? "selected" : ""}>Not Picked</option>
                  <option ${currentStatus === "Ordered" ? "selected" : ""}>Ordered</option>
                </select>
              </div>
              <p><strong>Number:</strong> ${lead.number}</p>
              <p><strong>Problem:</strong> ${lead.Problem || "‚Äî"}</p>
              <p><strong>Time:</strong> ${new Date(lead.Time).toLocaleTimeString()}</p>
              <input type="text" placeholder="Add a remark..." data-remark="${lead.number}" class="w-full mt-2 bg-white/10 border border-white/30 rounded px-3 py-2 text-white placeholder-white/70 focus:outline-none focus:ring-1 focus:ring-blue-400" />
              <div class="flex justify-end mt-2">
                <button data-view="${lead.number}" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm">View</button>
                <button class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded-md followupBtn" 
          data-number="${lead.number}" 
          data-name="${lead.Name || ''}">
    Follow-up
  </button>
                </div>

            `;

            // ‚úÖ Event handlers
            card.querySelector(`[data-status="${lead.number}"]`).addEventListener("change", e => {
              update(ref(db, `Telecallers/${telecallerEmailKey}/Leads/${lead.number}`), { Status: e.target.value });
            });
            card.querySelector(`[data-edit="${lead.number}"]`).addEventListener("click", () => {
              const newName = prompt("Edit Lead Name:", lead.Name || "");
              if (newName) update(ref(db, `Telecallers/${telecallerEmailKey}/Leads/${lead.number}`), { Name: newName });
            });
            card.querySelector(`[data-remark="${lead.number}"]`).addEventListener("keypress", e => {
              if (e.key === "Enter" && e.target.value.trim()) {
                const remarkText = e.target.value.trim();
                const remarkRef = ref(db, `Telecallers/${telecallerEmailKey}/Leads/${lead.number}/Remarks`);
                set(push(remarkRef), { text: remarkText, time: new Date().toISOString() });
                e.target.value = "";
              }
            });
            card.querySelector(`[data-view="${lead.number}"]`).addEventListener("click", () => openRemarksModal(lead.number, lead.Name));
            section.appendChild(card);
          });
        leadsContainer.appendChild(section);
      });
    }

    // ‚úÖ Remarks Modal Logic
    const remarksModal = document.getElementById("remarksModal");
    const remarksList = document.getElementById("remarksList");
    const remarksTitle = document.getElementById("remarksTitle");
    document.getElementById("closeRemarks").addEventListener("click", () => remarksModal.classList.add("hidden"));

    function openRemarksModal(number, name) {
      remarksList.innerHTML = "";
      remarksTitle.textContent = `Remarks for ${name} (${number})`;
      remarksModal.classList.remove("hidden");
      const remarksRef = ref(db, `Telecallers/${telecallerEmailKey}/Leads/${number}/Remarks`);
      onValue(remarksRef, snapshot => {
        remarksList.innerHTML = snapshot.exists()
          ? Object.values(snapshot.val())
              .sort((a, b) => new Date(b.time) - new Date(a.time))
              .map(r => `<li class="bg-gray-100 p-2 rounded mb-2"><p>${r.text}</p><p class="text-xs text-gray-500">${new Date(r.time).toLocaleString()}</p></li>`)
              .join("")
          : `<li class="text-gray-500 text-center">No remarks yet.</li>`;
      });
    }

    // ‚úÖ Logout + Followups
    document.getElementById("logoutBtn").addEventListener("click", () => {
      update(ref(db, `Telecallers/${telecallerEmailKey}`), { Status: false });
      localStorage.removeItem("currentTelecaller");
      window.location.href = "index.html";
    });
    document.getElementById("followupBtn").addEventListener("click", () => {
      window.location.href = "followups.html";
    });

   // =============== FOLLOW-UP MODAL HANDLING ===============

const followupModal = document.getElementById("followupModal");
const followupNumberEl = document.getElementById("followupNumber");
const followupNameEl = document.getElementById("followupName");
const followupDateEl = document.getElementById("followupDate");
const followupTimeEl = document.getElementById("followupTime");

let selectedFollowup = null;

// Open follow-up modal
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("followupBtn")) {
    selectedFollowup = {
      number: e.target.dataset.number,
      name: e.target.dataset.name
    };
    followupNumberEl.textContent = selectedFollowup.number;
    followupNameEl.textContent = selectedFollowup.name || "‚Äî";
    followupDateEl.value = "";
    followupTimeEl.value = "";
    followupModal.classList.remove("hidden");
  }
});

// Cancel button
document.getElementById("cancelFollowup").addEventListener("click", () => {
  followupModal.classList.add("hidden");
  selectedFollowup = null;
});

// Save follow-up
document.getElementById("saveFollowup").addEventListener("click", async () => {
  if (!selectedFollowup) return;
  const followupDate = followupDateEl.value;
  const followupTime = followupTimeEl.value;

  if (!followupDate || !followupTime) {
    alert("‚ö†Ô∏è Please select both date and time!");
    return;
  }

  const safeEmail = currentTelecaller.email.replace(/\./g, "_");
  const followupRef = ref(db, `Telecallers/${safeEmail}/Followups/${selectedFollowup.number}`);

  await set(followupRef, {
    Name: selectedFollowup.name || "‚Äî",
    "Follow-Up Date": followupDate,
    "Follow-Up Time": followupTime
  });

  alert("‚úÖ Follow-up saved successfully!");
  followupModal.classList.add("hidden");
});

// ===============================
// ‚úÖ Follow-up Notification Logic (with Debug Logs)
// ===============================
function checkDueFollowups() {
  console.log("‚è±Ô∏è Checking for due followups...");
  const followupsRef = ref(db, `Telecallers/${telecallerEmailKey}/Followups`);
  
  onValue(followupsRef, (snapshot) => {
    let dueCount = 0;

    if (snapshot.exists()) {
      const followups = snapshot.val();
      const now = new Date();
      console.log("üì¶ Found followups:", followups);

      Object.entries(followups).forEach(([number, data]) => {
        const dateStr = data["Follow-Up Date"];
        const timeStr = data["Follow-Up Time"];
        const name = data["Name"];

        if (!dateStr || !timeStr) {
          console.log(`‚ö†Ô∏è Skipping ${number} - missing date/time`);
          return;
        }

        // Convert strings to a Date object
        const [year, month, day] = dateStr.split("-").map(Number);
        const [hour, minute] = timeStr.split(":").map(Number);
        const followupDateTime = new Date(year, month - 1, day, hour, minute);

        const diff = now - followupDateTime;
        console.log(`üìÖ Lead: ${name} (${number}) | Follow-up: ${followupDateTime.toLocaleString()} | Diff(ms): ${diff}`);

        // If followup is due now or overdue, count it
        if (diff >= 0) {
          dueCount++;
          console.log(`üö® Followup due now for ${name} (${number})`);
          // Still show popup only once per day per (date+time)
          showFollowupPopup(number, name, dateStr, timeStr);
        }
      });
    } else {
      console.log("‚ùå No followups found in Firebase.");
    }

    // ‚úÖ Update or create badge (always shows current due count)
    let badge = document.getElementById("followupBadge");
    if (!badge) {
      const followupBtn = document.getElementById("followupBtn");
      badge = document.createElement("span");
      badge.id = "followupBadge";
      badge.className =
        "absolute top-1 right-1 bg-red-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-full hidden";
      followupBtn.classList.add("relative");
      followupBtn.appendChild(badge);
      console.log("üÜï Created followup badge element");
    }

    badge.textContent = dueCount;
    badge.classList.toggle("hidden", dueCount === 0);
    console.log(`üî¥ Badge updated ‚Äî Due Count: ${dueCount}`);
  });
}

// ==================== FOLLOW-UP POPUP CONTROL ====================

// üß† Track shown popups (number + date + time)
function hasPopupShownToday(number, followDate, followTime) {
  const today = new Date().toDateString();
  const key = `${number}_${followDate}_${followTime}`;
  const shownData = JSON.parse(localStorage.getItem("shownFollowups") || "{}");

  // Clean outdated entries
  for (const id in shownData) {
    if (shownData[id].date !== today) {
      delete shownData[id];
    }
  }

  localStorage.setItem("shownFollowups", JSON.stringify(shownData));
  return shownData[key];
}

function markPopupAsShown(number, followDate, followTime) {
  const today = new Date().toDateString();
  const key = `${number}_${followDate}_${followTime}`;
  const shownData = JSON.parse(localStorage.getItem("shownFollowups") || "{}");
  shownData[key] = { date: today, shown: true };
  localStorage.setItem("shownFollowups", JSON.stringify(shownData));
}

// üó£Ô∏è Popup + voice alert (only once per follow-up time per day)
function showFollowupPopup(number, name, followDate, followTime) {
  console.log(`üîî Trying popup for ${name} (${number}) - ${followDate} ${followTime}`);

  if (hasPopupShownToday(number, followDate, followTime)) {
    console.log(`‚ö†Ô∏è Popup for ${number} on ${followDate} ${followTime} already shown today ‚Äî skipping.`);
    return;
  }

  markPopupAsShown(number, followDate, followTime);
  console.log(`‚úÖ Marked ${number} ${followDate} ${followTime} as shown today.`);

  // Overlay
  const overlay = document.createElement("div");
  overlay.className = "followup-popup fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50";

  // Popup box
  const popup = document.createElement("div");
  popup.className = "bg-white text-gray-800 p-6 rounded-2xl shadow-xl text-center w-[350px] relative animate-bounce";

  popup.innerHTML = `
    <button id="closePopup" class="absolute top-2 right-3 text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
    <h2 class="text-2xl font-bold text-red-600 mb-2">üö® Don't Miss Your Follow-Up!</h2>
    <p class="text-lg mb-2">Lead: <span class="font-semibold">${name}</span></p>
    <p class="text-lg mb-2">Number: <span class="font-semibold">${number}</span></p>
    <p class="text-sm text-gray-600">Please contact this lead now.</p>
  `;

  overlay.appendChild(popup);
  document.body.appendChild(overlay);

  // üó£Ô∏è Voice alert ‚Äî says ‚ÄúFollow up‚Äù until closed
  const speakFollowup = () => {
    const utter = new SpeechSynthesisUtterance("Follow up");
    utter.pitch = 1;
    utter.rate = 0.9;
    utter.volume = 1;
    speechSynthesis.speak(utter);
  };

  speakFollowup();
  const voiceInterval = setInterval(() => {
    speakFollowup();
  }, 4000);

  document.getElementById("closePopup").addEventListener("click", () => {
    clearInterval(voiceInterval);
    speechSynthesis.cancel();
    overlay.remove();
  });
}

// ‚úÖ Check every 60 seconds
console.log("üïí Starting periodic followup check every 60 seconds...");
setInterval(checkDueFollowups, 60000);
checkDueFollowups();




let lastFirebaseActivity = Date.now();
let firebaseActivityListener = null;

// ‚úÖ Function to update online/offline status
async function updateTelecallerStatus(isOnline) {
  if (!telecallerEmailKey) return;
  try {
    await set(ref(db, `Telecallers/${telecallerEmailKey}/Status`), isOnline);
    console.log(`‚úÖ Telecaller status set to: ${isOnline}`);
  } catch (err) {
    console.error("‚ùå Error updating status:", err);
  }
}

// ‚úÖ Start monitoring Firebase activity for this telecaller
function startFirebaseActivityMonitor() {
  const leadsRef = ref(db, `Telecallers/${telecallerEmailKey}/Leads`);
  const followupsRef = ref(db, `Telecallers/${telecallerEmailKey}/Followups`);

  // Monitor both Leads and Followups nodes
  firebaseActivityListener = [
    onValue(leadsRef, () => {
      lastFirebaseActivity = Date.now();
      console.log("üî• Firebase activity detected in Leads");
    }),
    onValue(followupsRef, () => {
      lastFirebaseActivity = Date.now();
      console.log("üî• Firebase activity detected in Followups");
    })
  ];

  // Every minute, check if no Firebase activity for 15 min
  setInterval(() => {
    const diff = Date.now() - lastFirebaseActivity;
    if (diff > 900000) { // 15 minutes = 900000 ms
      console.log("‚ö†Ô∏è No Firebase activity for 15 minutes ‚Äî auto logout...");
      handleLogout();
    }
  }, 60000);
}

// ‚úÖ Handle login
function handleLogin() {
  console.log("üü¢ Telecaller logged in");
  updateTelecallerStatus(true);
  startFirebaseActivityMonitor();
}

// ‚úÖ Handle logout
function handleLogout() {
  console.log("üî¥ Telecaller logging out...");
  updateTelecallerStatus(false);
  sessionStorage.removeItem("telecallerEmailKey");
  window.location.href = "index.html";
}

// ‚úÖ On tab close or refresh ‚Üí mark offline
window.addEventListener("beforeunload", () => {
  updateTelecallerStatus(false);
});

// ‚úÖ Initialize if logged in
if (telecallerEmailKey) {
  handleLogin();
}

  </script>


<!-- Follow-up Modal -->
<div id="followupModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-96">
    <h2 class="text-lg font-semibold mb-4">Set Follow-up</h2>
    <p class="text-gray-700 mb-2"><strong>Number:</strong> <span id="followupNumber"></span></p>
    <p class="text-gray-700 mb-4"><strong>Name:</strong> <span id="followupName"></span></p>

    <label class="block text-gray-700 mb-1">Follow-up Date:</label>
    <input type="date" id="followupDate" class="border border-gray-300 rounded-md w-full p-2 mb-3 text-black">

    <label class="block text-gray-700 mb-1">Follow-up Time:</label>
    <input type="time" id="followupTime" class="border border-gray-300 rounded-md w-full p-2 mb-4 text-black">

    <div class="flex justify-end space-x-3">
      <button id="cancelFollowup" class="px-4 py-2 rounded-md bg-red-300 hover:bg-red-400">Cancel</button>
      <button id="saveFollowup" class="px-4 py-2 rounded-md bg-green-500 text-white hover:bg-green-600">Save</button>
    </div>
  </div>
</div>


</body>
</html>
