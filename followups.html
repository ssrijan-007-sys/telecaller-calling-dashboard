<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Followups</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #2563eb, #1e3a8a, #3b82f6);
      background-size: 300% 300%;
      animation: bgShift 10s ease infinite;
      font-family: "Poppins", sans-serif;
    }
    @keyframes bgShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .glass {
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .glass:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    select { background: rgba(255,255,255,0.2); color: white; }
    option { color: black; }

    /* Confirm modal styles */
    .confirm-btn { padding: 0.5rem 0.75rem; border-radius: .375rem; }
  </style>
</head>
<body class="min-h-screen flex flex-col text-white">

  <!-- Navbar -->
  <nav class="flex justify-between items-center p-5 bg-white/10">
    <h1 id="welcomeText" class="text-xl font-semibold">Welcome</h1>
    <div class="flex items-center gap-3">
      <button id="leadsBtn" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-md text-sm font-medium">Leads</button>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md text-sm font-medium">Logout</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Followups</h2>

      <div class="flex items-center gap-3">
        <input type="text" id="searchBox" placeholder="Search by name or number..." class="px-3 py-2 rounded-md text-black w-64" />
        <select id="filterDropdown" class="px-3 py-2 rounded-md text-white">
          <option value="today">Today</option>
          <option value="total">Total</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
    </div>

    <div id="followupsContainer" class="flex flex-col gap-6 overflow-y-auto max-h-[80vh] p-2">
      <!-- Followups grouped by date will appear here -->
    </div>
  </main>

  <!-- Extend Followup Modal -->
  <div id="extendModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white text-black rounded-lg p-6 w-80 relative">
      <button id="closeExtend" class="absolute top-2 right-3 text-xl text-gray-500 hover:text-black">&times;</button>
      <h3 class="text-lg font-semibold mb-4">Extend Follow-up</h3>
      <p class="text-sm text-gray-600 mb-3">Change follow-up date & time for <span id="extendName" class="font-semibold">—</span></p>
      <label class="block mb-1 text-sm font-medium">Date</label>
      <input type="date" id="extendDate" class="w-full border rounded p-2 mb-3 text-black" />
      <label class="block mb-1 text-sm font-medium">Time</label>
      <input type="time" id="extendTime" class="w-full border rounded p-2 mb-4 text-black" />
      <div class="flex justify-end gap-3">
        <button id="cancelExtend" class="px-4 py-2 rounded bg-gray-300">Cancel</button>
        <button id="saveExtend" class="px-4 py-2 rounded bg-green-500 text-white">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal (used for Not Interested / Ordered) -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-60">
    <div class="bg-white text-black rounded-lg p-6 w-80 relative">
      <h3 id="confirmTitle" class="text-lg font-semibold mb-2">Confirm</h3>
      <p id="confirmMessage" class="text-sm text-gray-700 mb-4">Are you sure?</p>
      <div class="flex justify-end gap-3">
        <button id="confirmCancel" class="confirm-btn bg-gray-300">Cancel</button>
        <button id="confirmOk" class="confirm-btn bg-red-500 text-white">Yes, proceed</button>
      </div>
    </div>
  </div>

  <!-- Remarks Modal -->
  <div id="remarksModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white text-black rounded-lg w-96 max-h-[70vh] overflow-y-auto p-5 relative">
      <button id="closeRemarks" class="absolute top-2 right-3 text-xl text-gray-500 hover:text-black">&times;</button>
      <h3 id="remarksTitle" class="text-lg font-bold mb-3">Remarks</h3>
      <ul id="remarksList" class="space-y-2"></ul>
    </div>
  </div>

  <!-- Custom Date Range Modal -->
  <div id="customDateModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white text-black rounded-lg p-5 w-80 relative">
      <button id="closeDateModal" class="absolute top-2 right-3 text-xl text-gray-500 hover:text-black">&times;</button>
      <h3 class="text-lg font-semibold mb-4">Select Date Range</h3>
      <label class="block mb-2 text-sm font_medium">From:</label>
      <input type="date" id="fromDate" class="w-full border rounded p-2 mb-3">
      <label class="block mb-2 text-sm font_medium">To:</label>
      <input type="date" id="toDate" class="w-full border rounded p-2 mb-4">
      <button id="applyDateRange" class="bg-blue-500 hover:bg-blue-600 text-white w-full py-2 rounded">Apply</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, remove, update, push, get, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCaFjdwtxT13RdmVau9_6JEFBEIY1xojTY",
  authDomain: "shreejeeayucare-df742.firebaseapp.com",
  databaseURL: "https://shreejeeayucare-df742-default-rtdb.firebaseio.com",
  projectId: "shreejeeayucare-df742",
  storageBucket: "shreejeeayucare-df742.firebasestorage.app",
  messagingSenderId: "119318664445",
  appId: "1:119318664445:web:4399d3ddd4a9decc0f5a94",
  measurementId: "G-GKWG1RLZ5R"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const currentTelecaller = JSON.parse(localStorage.getItem("currentTelecaller"));
    if (!currentTelecaller || !currentTelecaller.email) window.location.href = "index.html";

    const telecallerEmailKey = currentTelecaller.email.replace(/\./g, "_");
    const welcomeText = document.getElementById("welcomeText");
    const followupsContainer = document.getElementById("followupsContainer");
    welcomeText.textContent = `Welcome, ${currentTelecaller.name || "Telecaller"}`;

    const searchBox = document.getElementById("searchBox");
    const filterDropdown = document.getElementById("filterDropdown");

    let customRange = null;

    // Confirm modal helpers
    const confirmModal = document.getElementById('confirmModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmCancel = document.getElementById('confirmCancel');
    const confirmOk = document.getElementById('confirmOk');
    let confirmAction = null;
    let confirmActionPayload = null;

    function showConfirm(title, message, action, payload) {
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      confirmAction = action;
      confirmActionPayload = payload;
      confirmModal.classList.remove('hidden');
    }
    confirmCancel.addEventListener('click', () => { confirmModal.classList.add('hidden'); confirmAction = null; confirmActionPayload = null; });
    confirmOk.addEventListener('click', async () => {
      confirmModal.classList.add('hidden');
      if (typeof confirmAction === 'function') {
        try { await confirmAction(confirmActionPayload); } catch (e) { console.error('Confirm action failed', e); }
      }
      confirmAction = null; confirmActionPayload = null;
    });

    // fetch followups
    const followupRef = ref(db, `Telecallers/${telecallerEmailKey}/Followups`);
    onValue(followupRef, (snapshot) => renderFollowups(snapshot));

    function renderFollowups(snapshot) {
      followupsContainer.innerHTML = "";
      if (!snapshot.exists()) {
        followupsContainer.innerHTML = `<p class="text-white/70 text-center py-10">No Followups Available</p>`;
        return;
      }

      let followups = Object.entries(snapshot.val()).map(([number, data]) => ({
  number,
  Name: data.Name || "—",
  date: data["Follow-Up Date"] || "",
  Problem: data.Problem || "",
  time: data["Follow-Up Time"] || ""
}));


      // search
      const q = searchBox.value.toLowerCase();
      if (q) followups = followups.filter(f => (f.Name || "").toLowerCase().includes(q) || f.number.includes(q));

      // filters
      const filter = filterDropdown.value;
      const now = new Date();
      if (filter === 'today') {
        const todayStr = now.toISOString().split('T')[0];
        followups = followups.filter(f => f.date === todayStr);
      } else if (filter === 'custom' && customRange) {
        followups = followups.filter(f => {
          const d = new Date(f.date);
          return d >= customRange.from && d <= new Date(customRange.to.getTime() + 24*60*60*1000 -1);
        });
      }

      // group by date
      const grouped = {};
      followups.forEach(f => {
        const key = f.date || new Date(f.Time || Date.now()).toISOString().split('T')[0];
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(f);
      });

      const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));

      if (sortedDates.length === 0) {
        followupsContainer.innerHTML = `<p class="text-white/70 text-center py-10">No Followups Found</p>`;
        return;
      }

      sortedDates.forEach(dateKey => {
        const section = document.createElement('div');
        section.innerHTML = `<h3 class="text-lg font-semibold mb-3 border-b border-white/20 pb-1">${new Date(dateKey).toDateString()}</h3>`;

        grouped[dateKey]
          .sort((a,b) => new Date(b.Time || b["Follow-Up Time"]) - new Date(a.Time || a["Follow-Up Time"]))
          .forEach(f => {
            const card = document.createElement('div');
            card.className = 'glass p-4 rounded-lg shadow-md mb-3';
            const currentStatus = f.Status || 'Not Called';

            card.innerHTML = `
              <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                  <h4 class="text-lg font-semibold">${f.Name || 'Unknown'}</h4>
                  <button class="text-yellow-400 hover:text-yellow-300 text-sm font-semibold" data-edit="${f.number}">✏️</button>
                </div>
                <select data-status="${f.number}" class="rounded-md text-sm px-2 py-1">
                  <option ${currentStatus === 'Not Called' ? 'selected' : ''}>Not Called</option>
                  <option ${currentStatus === 'Not Interested' ? 'selected' : ''}>Not Interested</option>
                  <option ${currentStatus === 'Picked' ? 'selected' : ''}>Picked</option>
                  <option ${currentStatus === 'Not Picked' ? 'selected' : ''}>Not Picked</option>
                  <option ${currentStatus === 'Ordered' ? 'selected' : ''}>Ordered</option>
                </select>
              </div>

              <p><strong>Number:</strong> ${f.number}</p>
              <p><strong>Problem:</strong> ${f.Problem || '—'}</p>
              <p><strong>Follow-Up Time:</strong> ${f.time || "—"}</p>


              <input type="text" placeholder="Add a remark..." data-remark="${f.number}" class="w-full mt-2 bg-white/10 border border-white/30 rounded px-3 py-2 text-white placeholder-white/70 focus:outline-none focus:ring-1 focus:ring-blue-400" />

              <div class="flex justify-end mt-2 gap-2">
                <button data-view="${f.number}" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm">View</button>
                <button data-extend="${f.number}" data-name="${f.Name || ''}" class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded-md">Extend follow-up</button>
                <button data-remove="${f.number}" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">Remove</button>
              </div>
            `;

            // status change handler (with confirm modals for destructive actions)
            const statusEl = card.querySelector(`[data-status="${f.number}"]`);
            statusEl.addEventListener('change', (e) => {
              const newStatus = e.target.value;
              const prevStatus = f.Status || 'Not Called';

              // If user selects Not Interested — show confirm modal to delete
              if (newStatus === 'Not Interested') {
                // revert select back until action confirmed
                e.target.value = prevStatus;
                showConfirm('Delete follow-up', 'Marking as Not Interested will delete this follow-up permanently. Continue?', async () => {
                  await remove(ref(db, `Telecallers/${telecallerEmailKey}/Followups/${f.number}`));
                });
                return;
              }

              // If user selects Ordered — ask and move lead to Ordered node
              if (newStatus === 'Ordered') {
              e.target.value = prevStatus;

              showConfirm(
                'Mark as Ordered',
                'This will move the follow-up to Ordered. Continue?',
                async () => {
                  const now = new Date();

                  const orderedRef = ref(
                    db,
                    `Telecallers/${telecallerEmailKey}/Ordered/${f.number}`
                  );

                  const orderedData = {
                    ...f,
                    "Follow-Up Date": now.toISOString().split('T')[0],
                    "Follow-Up Time": now.toTimeString().slice(0, 5),
                    Status: "Ordered"
                  };

                  try {
                    await set(orderedRef, orderedData);
                    await remove(
                      ref(db, `Telecallers/${telecallerEmailKey}/Followups/${f.number}`)
                    );
                  } catch (err) {
                    console.error('Failed to move to Ordered:', err);
                  }
                }
              );

              return;
            }


              // Normal status updates
              update(ref(db, `Telecallers/${telecallerEmailKey}/Followups/${f.number}`), { Status: newStatus });
            });

            // edit name
            card.querySelector(`[data-edit="${f.number}"]`).addEventListener('click', async () => {
              const newName = prompt('Edit Name:', f.Name || '');
              if (newName !== null) {
                await update(ref(db, `Telecallers/${telecallerEmailKey}/Followups/${f.number}`), { Name: newName });
              }
            });

            // remark input
            card.querySelector(`[data-remark="${f.number}"]`).addEventListener('keypress', async (e) => {
              if (e.key === 'Enter' && e.target.value.trim()) {
                const text = e.target.value.trim();
                const remarkRef = ref(db, `Telecallers/${telecallerEmailKey}/Followups/${f.number}/Remarks`);
                await push(remarkRef, { text, time: new Date().toISOString() });
                e.target.value = '';
              }
            });

            // view remarks
            card.querySelector(`[data-view="${f.number}"]`).addEventListener('click', () => openRemarksModal(f.number, f.Name));

            // extend followup
            card.querySelector(`[data-extend="${f.number}"]`).addEventListener('click', async (e) => {
              document.getElementById('extendName').textContent = e.target.dataset.name || '—';
              document.getElementById('extendModal').classList.remove('hidden');
              document.getElementById('extendModal').dataset.number = f.number;

              // prefill date/time
              const dateVal = f.date;
              const timeVal = f.time;
              document.getElementById('extendDate').value = dateVal;
              document.getElementById('extendTime').value = timeVal;
            });

            // remove followup
            card.querySelector(`[data-remove="${f.number}"]`).addEventListener('click', () => {
              showConfirm('Delete follow-up', 'Are you sure you want to delete this follow-up?', async () => {
                await remove(ref(db, `Telecallers/${telecallerEmailKey}/Followups/${f.number}`));
              });
            });

            section.appendChild(card);
          });

        followupsContainer.appendChild(section);
      });
    }

    // Extend modal controls
    document.getElementById('closeExtend').addEventListener('click', () => document.getElementById('extendModal').classList.add('hidden'));
    document.getElementById('cancelExtend').addEventListener('click', () => document.getElementById('extendModal').classList.add('hidden'));

    document.getElementById('saveExtend').addEventListener('click', async () => {
      const num = document.getElementById('extendModal').dataset.number;
      const date = document.getElementById('extendDate').value;
      const time = document.getElementById('extendTime').value;
      if (!date || !time) { alert('Please select both date and time'); return; }
      await update(ref(db, `Telecallers/${telecallerEmailKey}/Followups/${num}`), { 'Follow-Up Date': date, 'Follow-Up Time': time });
      document.getElementById('extendModal').classList.add('hidden');
      alert('Follow-up extended');
    });

    // Remarks modal
    const remarksModal = document.getElementById('remarksModal');
    const remarksList = document.getElementById('remarksList');
    const remarksTitle = document.getElementById('remarksTitle');
    document.getElementById('closeRemarks').addEventListener('click', () => remarksModal.classList.add('hidden'));

    function openRemarksModal(number, name) {
      remarksList.innerHTML = '';
      remarksTitle.textContent = `Remarks for ${name} (${number})`;
      remarksModal.classList.remove('hidden');
      const rRef = ref(db, `Telecallers/${telecallerEmailKey}/Followups/${number}/Remarks`);
      onValue(rRef, snap => {
        if (!snap.exists()) { remarksList.innerHTML = '<li class="text-gray-500 text-center">No remarks yet.</li>'; return; }
        const arr = Object.values(snap.val()).sort((a,b)=> new Date(b.time)-new Date(a.time));
        remarksList.innerHTML = arr.map(r => `<li class="bg-gray-100 p-2 rounded mb-2"><p>${r.text}</p><p class="text-xs text-gray-500">${new Date(r.time).toLocaleString()}</p></li>`).join('');
      });
    }

    // search/filter events
    searchBox.addEventListener('input', () => onValue(followupRef, (snap) => renderFollowups(snap)));
    filterDropdown.addEventListener('change', (e) => {
      if (e.target.value === 'custom') document.getElementById('customDateModal').classList.remove('hidden');
      else { customRange = null; onValue(followupRef, (snap)=> renderFollowups(snap)); }
    });

    document.getElementById('closeDateModal').addEventListener('click', () => document.getElementById('customDateModal').classList.add('hidden'));
    document.getElementById('applyDateRange').addEventListener('click', () => {
      const from = new Date(document.getElementById('fromDate').value);
      const to = new Date(document.getElementById('toDate').value);
      if (!isNaN(from) && !isNaN(to)) { customRange = { from, to }; document.getElementById('customDateModal').classList.add('hidden'); onValue(followupRef, (snap)=> renderFollowups(snap)); }
    });

    // navbar
    document.getElementById('leadsBtn').addEventListener('click', () => window.location.href = 'telecaller-dashboard.html');
    document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.removeItem('currentTelecaller'); window.location.href = 'index.html'; });




    import {
  onDisconnect,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const statusRef = ref(db, `Telecallers/${telecallerEmailKey}/Status`);
const lastActiveRef = ref(db, `Telecallers/${telecallerEmailKey}/LastActive`);

// ✅ Mark online immediately
set(statusRef, true);
set(lastActiveRef, serverTimestamp());

// ✅ Mark offline ONLY if connection truly drops
onDisconnect(statusRef).set(false);
onDisconnect(lastActiveRef).set(serverTimestamp());

  </script>
</body>
</html>
